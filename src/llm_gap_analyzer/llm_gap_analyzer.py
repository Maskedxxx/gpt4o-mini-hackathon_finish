# src/llm_gap_analyzer/llm_gap_analyzer.py
import os
from typing import Optional, Dict, Any
from openai import OpenAI
from pydantic import ValidationError
import instructor

# –î–û–ë–ê–í–ò–¢–¨ –∏–º–ø–æ—Ä—Ç—ã LangSmith
from langsmith.wrappers import wrap_openai
from langsmith import traceable, Client

from src.utils import get_logger
from src.llm_gap_analyzer import settings
from src.models.gap_analysis_models import EnhancedResumeTailoringAnalysis
from src.llm_gap_analyzer.formatter import format_resume_data, format_vacancy_data

logger = get_logger()

# –î–û–ë–ê–í–ò–¢–¨ —Å–æ–∑–¥–∞–Ω–∏–µ LangSmith –∫–ª–∏–µ–Ω—Ç–∞
def create_langsmith_client():
    """–°–æ–∑–¥–∞—ë—Ç –∫–ª–∏–µ–Ω—Ç–∞ LangSmith –¥–ª—è —Ç—Ä–µ–π—Å–∏–Ω–≥–∞."""
    api_key = os.getenv("LANGCHAIN_API_KEY")
    if not api_key:
        logger.warning("LANGCHAIN_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, —Ç—Ä–µ–π—Å–∏–Ω–≥ –±—É–¥–µ—Ç –æ—Ç–∫–ª—é—á–µ–Ω")
        return None
    return Client(api_key=api_key)

# –°–æ–∑–¥–∞—ë–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –¥–ª—è —Ç—Ä–µ–π—Å–∏–Ω–≥–∞
ls_client = create_langsmith_client()


class LLMGapAnalyzer:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ä–µ–∑—é–º–µ —Å –ø–æ–º–æ—â—å—é OpenAI API"""
    
    def __init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ OpenAI —Å LangSmith —Ç—Ä–µ–π—Å–∏–Ω–≥–æ–º."""
        self.config = settings
        self.model = self.config.model_name
        
        # –ó–ê–ú–ï–ù–ò–¢–¨ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ –≤–µ—Ä—Å–∏—é —Å —Ç—Ä–µ–π—Å–∏–Ω–≥–æ–º
        self.client = self._create_traced_client()
        logger.info(f"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω GAP –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —Å –º–æ–¥–µ–ª—å—é {self.model}")
    
    def _create_traced_client(self) -> OpenAI:
        """–°–æ–∑–¥–∞–µ—Ç OpenAI –∫–ª–∏–µ–Ω—Ç —Å LangSmith —Ç—Ä–µ–π—Å–∏–Ω–≥–æ–º."""
        # –°–æ–∑–¥–∞—ë–º –±–∞–∑–æ–≤—ã–π OpenAI –∫–ª–∏–µ–Ω—Ç
        base_client = OpenAI(api_key=self.config.api_key)
        
        # –ï—Å–ª–∏ LangSmith –¥–æ—Å—Ç—É–ø–µ–Ω, –æ–±–æ—Ä–∞—á–∏–≤–∞–µ–º –∫–ª–∏–µ–Ω—Ç
        if ls_client:
            logger.info("LangSmith —Ç—Ä–µ–π—Å–∏–Ω–≥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –¥–ª—è GAP –∞–Ω–∞–ª–∏–∑–∞")
            wrapped_client = wrap_openai(base_client)
            return wrapped_client
        else:
            logger.info("LangSmith —Ç—Ä–µ–π—Å–∏–Ω–≥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∞–∑–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç")
            return base_client
    
    def _create_gap_analysis_prompt(self, parsed_resume: Dict[str, Any], parsed_vacancy: Dict[str, Any]) -> str:
        """–°–æ–∑–¥–∞–µ—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è gap-–∞–Ω–∞–ª–∏–∑–∞ —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏."""
        formatted_resume = format_resume_data(parsed_resume)
        formatted_vacancy = format_vacancy_data(parsed_vacancy)
        
        logger.debug("–°–æ–∑–¥–∞–Ω –ø—Ä–æ–º–ø—Ç –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ GAP –∞–Ω–∞–ª–∏–∑–∞")
        
        return f"""
# –†–û–õ–¨: –¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç HR —Å 10+ –ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º GAP-–∞–Ω–∞–ª–∏–∑–∞ —Ä–µ–∑—é–º–µ –≤ IT-—Å—Ñ–µ—Ä–µ

## –ö–û–ù–¢–ï–ö–°–¢ –ó–ê–î–ê–ß–ò
–¢—ã –ø—Ä–æ–≤–æ–¥–∏—à—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π GAP-–∞–Ω–∞–ª–∏–∑ —Ä–µ–∑—é–º–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≤–∞–∫–∞–Ω—Å–∏–∏. 
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∏–º–∏—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –æ—Ü–µ–Ω–∫–∏, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–ø—ã—Ç–Ω—ã–µ —Ä–µ–∫—Ä—É—Ç–µ—Ä—ã.

## –ò–°–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï

{formatted_resume}

{formatted_vacancy}

## –ú–ï–¢–û–î–û–õ–û–ì–ò–Ø –ê–ù–ê–õ–ò–ó–ê (—Å–ª–µ–¥—É–π —Å—Ç—Ä–æ–≥–æ –ø–æ —ç—Ç–∞–ø–∞–º)

### –≠–¢–ê–ü 1: –ü–ï–†–í–ò–ß–ù–´–ô –°–ö–†–ò–ù–ò–ù–ì (7-15 —Å–µ–∫—É–Ω–¥)
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –±–∞–∑–æ–≤—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ HR –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤ –ø–µ—Ä–≤—ã–µ —Å–µ–∫—É–Ω–¥—ã:
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ –≤ —Ä–µ–∑—é–º–µ –∏ –≤–∞–∫–∞–Ω—Å–∏–∏
- –û–±—â–∏–π —Å—Ç–∞–∂ –≤ –Ω—É–∂–Ω–æ–π —Å—Ñ–µ—Ä–µ vs —Ç—Ä–µ–±—É–µ–º—ã–π
- –ù–∞–ª–∏—á–∏–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –Ω–∞–≤—ã–∫–æ–≤ (–≤–∏–¥–Ω—ã –ª–∏ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞)
- –õ–æ–∫–∞—Ü–∏—è –∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Ä–∞–±–æ—Ç–µ
- –ó–∞—Ä–ø–ª–∞—Ç–Ω—ã–µ –æ–∂–∏–¥–∞–Ω–∏—è vs –±—é–¥–∂–µ—Ç –≤–∞–∫–∞–Ω—Å–∏–∏

### –≠–¢–ê–ü 2: –ö–õ–ê–°–°–ò–§–ò–ö–ê–¶–ò–Ø –¢–†–ï–ë–û–í–ê–ù–ò–ô
–†–∞–∑–¥–µ–ª–∏ –í–°–ï —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –≤–∞–∫–∞–Ω—Å–∏–∏ –Ω–∞:
- **MUST-HAVE** (–±–µ–∑ —ç—Ç–æ–≥–æ —Ä–∞–±–æ—Ç–∞ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞)
- **NICE-TO-HAVE** (–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –º–æ–∂–Ω–æ —Ä–∞–∑–≤–∏—Ç—å)
- **–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ü–õ–Æ–°–´** (–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞)

### –≠–¢–ê–ü 3: –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –°–û–û–¢–í–ï–¢–°–¢–í–ò–Ø
–î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –æ–ø—Ä–µ–¥–µ–ª–∏:
- ‚úÖ **–ü–û–õ–ù–û–ï –°–û–û–¢–í–ï–¢–°–¢–í–ò–ï** - —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ
- ‚ö†Ô∏è **–ß–ê–°–¢–ò–ß–ù–û–ï –°–û–û–¢–í–ï–¢–°–¢–í–ò–ï** - –µ—Å—Ç—å —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ, –Ω–æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≥–ª—É–±–æ–∫–æ
- ‚ùå **–û–¢–°–£–¢–°–¢–í–£–ï–¢** - —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –Ω–µ –æ—Ç—Ä–∞–∂–µ–Ω–æ –≤ —Ä–µ–∑—é–º–µ
- üîç **–¢–†–ï–ë–£–ï–¢ –£–¢–û–ß–ù–ï–ù–ò–Ø** - –Ω–µ—è—Å–Ω–æ –∏–∑ —Ä–µ–∑—é–º–µ

### –≠–¢–ê–ü 4: –ê–ù–ê–õ–ò–ó –ö–ê–ß–ï–°–¢–í–ê –ü–†–ï–ó–ï–ù–¢–ê–¶–ò–ò
–û—Ü–µ–Ω–∏ –ö–ê–ö –∫–∞–Ω–¥–∏–¥–∞—Ç –ø–æ–¥–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:
- –ù–∞–ª–∏—á–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π vs –æ–±—â–∏–µ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –∏ —á–∏—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å
- –†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –æ–ø–∏—Å–∞–Ω–Ω–æ–≥–æ –æ–ø—ã—Ç–∞
- –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –≤–∞–∫–∞–Ω—Å–∏—é

## –ö–†–ò–¢–ï–†–ò–ò –ö–ê–ß–ï–°–¢–í–ï–ù–ù–û–ì–û –ê–ù–ê–õ–ò–ó–ê

### Hard Skills:
- –ü—Ä–æ–≤–µ—Ä—å –¢–û–ß–ù–û–ï —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏–π —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π (Django vs "–≤–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∏")
- –û—Ü–µ–Ω–∏ –≥–ª—É–±–∏–Ω—É –æ–ø—ã—Ç–∞ –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é –ø—Ä–æ–µ–∫—Ç–æ–≤
- –°–æ–ø–æ—Å—Ç–∞–≤—å —É—Ä–æ–≤–µ–Ω—å –∑–∞–¥–∞—á –≤ —Ä–µ–∑—é–º–µ —Å —É—Ä–æ–≤–Ω–µ–º –≤–∞–∫–∞–Ω—Å–∏–∏

### Soft Skills:
- –ò—â–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —á–µ—Ä–µ–∑ —Ñ–∞–∫—Ç—ã, –∞ –Ω–µ –¥–µ–∫–ª–∞—Ä–∞—Ü–∏–∏
- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫–∞—á–µ—Å—Ç–≤–æ —Å–∞–º–æ–≥–æ —Ä–µ–∑—é–º–µ –∫–∞–∫ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞–≤—ã–∫–æ–≤
- –û—Ü–µ–Ω–∏–≤–∞–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –º–∞–Ω–µ—Ä—ã –∏–∑–ª–æ–∂–µ–Ω–∏—è –∫—É–ª—å—Ç—É—Ä–µ –∫–æ–º–ø–∞–Ω–∏–∏

### –û–ø—ã—Ç:
- –†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å —Å—Ñ–µ—Ä—ã –∏ –∑–∞–¥–∞—á
- –ö–∞—Ä—å–µ—Ä–Ω–∞—è —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—è (—Ä–æ—Å—Ç, —Å—Ç–∞–≥–Ω–∞—Ü–∏—è, —Å–∫–∞—á–∫–∏)
- –ú–∞—Å—à—Ç–∞–± –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

## –§–û–†–ú–ê–¢ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ô
–î–ª—è –∫–∞–∂–¥–æ–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —É–∫–∞–∑—ã–≤–∞–π:
1. **–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å**: –ö–†–ò–¢–ò–ß–ù–û / –í–ê–ñ–ù–û / –ñ–ï–õ–ê–¢–ï–õ–¨–ù–û
2. **–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ**: –ø–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –¥–∞–Ω–Ω–æ–π –≤–∞–∫–∞–Ω—Å–∏–∏
3. **–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è**: —á—Ç–æ –∏–º–µ–Ω–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å/–∏–∑–º–µ–Ω–∏—Ç—å/—É–±—Ä–∞—Ç—å
4. **–ü—Ä–∏–º–µ—Ä—ã —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫**: –∫–∞–∫ –ª—É—á—à–µ –Ω–∞–ø–∏—Å–∞—Ç—å

## –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø
- –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—é HR
- –£—á–∏—Ç—ã–≤–∞–π —Å–ø–µ—Ü–∏—Ñ–∏–∫—É —Ä–æ—Å—Å–∏–π—Å–∫–æ–≥–æ IT-—Ä—ã–Ω–∫–∞
- –î–∞–≤–∞–π actionable —Å–æ–≤–µ—Ç—ã, –∞ –Ω–µ –æ–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
- –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä—É–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤–ª–∏—è–Ω–∏—é –Ω–∞ —Ä–µ—à–µ–Ω–∏–µ –æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–∏

–ü—Ä–æ–≤–µ–¥–∏ –∞–Ω–∞–ª–∏–∑ –∏ –≤–µ—Ä–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON —Å–æ–≥–ª–∞—Å–Ω–æ –º–æ–¥–µ–ª–∏ EnhancedResumeTailoringAnalysis.
"""
    
    @traceable(client=ls_client, project_name="llamaindex_test", run_type = "retriever")
    async def gap_analysis(self, parsed_resume: Dict[str, Any], parsed_vacancy: Dict[str, Any]) -> Optional[EnhancedResumeTailoringAnalysis]:
        """–í—ã–ø–æ–ª–Ω—è–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π GAP-–∞–Ω–∞–ª–∏–∑ —Ä–µ–∑—é–º–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –≤–∞–∫–∞–Ω—Å–∏–∏ —Å —Ç—Ä–µ–π—Å–∏–Ω–≥–æ–º."""
        try:
            logger.info("–ù–∞—á–∞—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π GAP –∞–Ω–∞–ª–∏–∑ —Ä–µ–∑—é–º–µ —Å —Ç—Ä–µ–π—Å–∏–Ω–≥–æ–º")
            
            # 1. –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç –¥–ª—è GAP-–∞–Ω–∞–ª–∏–∑–∞
            prompt_text = self._create_gap_analysis_prompt(parsed_resume, parsed_vacancy)
            
            # 2. –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è chat-completion
            messages = [
                {
                    "role": "system",
                    "content": (
                        "–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ä–µ–∫—Ä—É—Ç–∏–Ω–≥—É –∏ HR —Å –≥–ª—É–±–æ–∫–∏–º –ø–æ–Ω–∏–º–∞–Ω–∏–µ–º IT-–∏–Ω–¥—É—Å—Ç—Ä–∏–∏. "
                        "–¢–≤–æ—è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π GAP-–∞–Ω–∞–ª–∏–∑ —Ä–µ–∑—é–º–µ —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º–∏ "
                        "—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏. –í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π —Å—Ç—Ä–æ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON —Å–æ–≥–ª–∞—Å–Ω–æ "
                        "—É–∫–∞–∑–∞–Ω–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ EnhancedResumeTailoringAnalysis. –ê–Ω–∞–ª–∏–∑ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å "
                        "–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–º."
                    )
                },
                {
                    "role": "user",
                    "content": prompt_text
                }
            ]
            
            logger.debug(f"–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ OpenAI API —Å –º–æ–¥–µ–ª—å—é {self.model}")
            
            # 3. –í—ã–∑–≤–∞—Ç—å OpenAI API (—Ç–µ–ø–µ—Ä—å —Å —Ç—Ä–µ–π—Å–∏–Ω–≥–æ–º)
            completion = self.client.beta.chat.completions.parse(
                temperature=0.2,
                model=self.model,
                messages=messages,
                response_format=EnhancedResumeTailoringAnalysis,
            )

            # 4. –ò–∑–≤–ª–µ—á—å –æ—Ç–≤–µ—Ç
            raw_response_text = completion.choices[0].message.content
            if not raw_response_text:
                logger.error("–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏ –ø—Ä–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–º GAP-–∞–Ω–∞–ª–∏–∑–µ")
                return None
            
            # 5. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON –≤ –º–æ–¥–µ–ª—å
            gap_result = EnhancedResumeTailoringAnalysis.model_validate_json(raw_response_text)
            logger.info("–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π GAP-–∞–Ω–∞–ª–∏–∑ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω —Å —Ç—Ä–µ–π—Å–∏–Ω–≥–æ–º")
            
            # –î–û–ë–ê–í–ò–¢–¨ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –¥–ª—è —Ç—Ä–µ–π—Å–∏–Ω–≥–∞
            if ls_client:
                logger.info(f"–¢—Ä–µ–π—Å–∏–Ω–≥: –∞–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω, –ø—Ä–æ—Ü–µ–Ω—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è: {gap_result.overall_match_percentage}%")
            
            return gap_result

        except ValidationError as ve:
            logger.error(f"–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ GAP-–∞–Ω–∞–ª–∏–∑–∞: {ve}")
            # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –≤ —Ç—Ä–µ–π—Å–∏–Ω–≥
            if ls_client:
                logger.error(f"–¢—Ä–µ–π—Å–∏–Ω–≥: –æ—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ - {ve}")
            return None
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–º GAP-–∞–Ω–∞–ª–∏–∑–µ: {e}", exc_info=True)
            # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –≤ —Ç—Ä–µ–π—Å–∏–Ω–≥
            if ls_client:
                logger.error(f"–¢—Ä–µ–π—Å–∏–Ω–≥: –æ–±—â–∞—è –æ—à–∏–±–∫–∞ - {e}")
            return None